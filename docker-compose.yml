version: '3.8'

services:
  camille-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: camille-discord-bot
    restart: unless-stopped

    # Variables d'environnement
    environment:
      - NODE_ENV=production
      - TZ=Europe/Paris
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - GUILD_ID=${GUILD_ID}
      - CLIENT_ID=${CLIENT_ID}
      - DOCKER_BUILDKIT=0

    # Volumes pour persister les données
    volumes:
      - ./logs:/app/logs
      - ./daily_claim_usage:/app/daily_claim_usage
      - ./MONTHLY_USAGE:/app/MONTHLY_USAGE
      - ./lastVideoId.txt:/app/lastVideoId.txt
      - ./lastVideoId2.txt:/app/lastVideoId2.txt

    # Limites de ressources adaptées au Raspberry Pi 5
    deploy:
      resources:
        limits:
          cpus: '3.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'node main.js' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Capabilities pour Puppeteer/Chromium
    cap_add:
      - SYS_ADMIN
    shm_size: '2gb'